/*!
 * backbone.iobind
 * Copyright(c) 2011 Jake Luer <jake@alogicalparadox.com>
 * MIT Licensed
 * https://github.com/logicalparadox/backbone.iobind
 */

(function(undefined){var _,$,Backbone,exports;if(typeof window==="undefined"||typeof require==="function"){$=require("jquery");_=require("underscore");Backbone=require("backbone");exports=Backbone;if(typeof module!=="undefined")module.exports=exports}else{$=this.$;_=this._;Backbone=this.Backbone;exports=this}Backbone.Model.prototype.ioBindVersion="0.4.5";Backbone.Model.prototype.ioBind=function(eventName,io,callback,context){var ioEvents=this._ioEvents||(this._ioEvents={}),globalName=this.url()+":"+eventName,self=this;if("function"==typeof io){context=callback;callback=io;io=this.socket||window.socket||Backbone.socket}var event={name:eventName,global:globalName,cbLocal:callback,cbGlobal:function(){var args=[eventName];args.push.apply(args,arguments);self.trigger.apply(self,args)}};this.bind(event.name,event.cbLocal,context||self);io.on(event.global,event.cbGlobal);if(!ioEvents[event.name]){ioEvents[event.name]=[event]}else{ioEvents[event.name].push(event)}return this};Backbone.Model.prototype.ioUnbind=function(eventName,io,callback){var ioEvents=this._ioEvents||(this._ioEvents={}),globalName=this.url()+":"+eventName;if("function"==typeof io){callback=io;io=this.socket||window.socket||Backbone.socket}var events=ioEvents[eventName];if(!_.isEmpty(events)){if(callback&&"function"===typeof callback){for(var i=0,l=events.length;i<l;i++){if(callback==events[i].cbLocal){this.unbind(events[i].name,events[i].cbLocal);io.removeListener(events[i].global,events[i].cbGlobal);events[i]=false}}events=_.compact(events)}else{this.unbind(eventName);io.removeAllListeners(globalName)}if(events.length===0){delete ioEvents[eventName]}}return this};Backbone.Model.prototype.ioUnbindAll=function(io){var ioEvents=this._ioEvents||(this._ioEvents={});if(!io)io=this.socket||window.socket||Backbone.socket;for(var ev in ioEvents){this.ioUnbind(ev,io)}return this};Backbone.Collection.prototype.ioBindVersion="0.4.5";Backbone.Collection.prototype.ioBind=function(eventName,io,callback,context){var ioEvents=this._ioEvents||(this._ioEvents={}),globalName=this.url+":"+eventName,self=this;if("function"==typeof io){context=callback;callback=io;io=this.socket||window.socket||Backbone.socket}var event={name:eventName,global:globalName,cbLocal:callback,cbGlobal:function(){var args=[eventName];args.push.apply(args,arguments);self.trigger.apply(self,args)}};this.bind(event.name,event.cbLocal,context);io.on(event.global,event.cbGlobal);if(!ioEvents[event.name]){ioEvents[event.name]=[event]}else{ioEvents[event.name].push(event)}return this};Backbone.Collection.prototype.ioUnbind=function(eventName,io,callback){var ioEvents=this._ioEvents||(this._ioEvents={}),globalName=this.url+":"+eventName;if("function"==typeof io){callback=io;io=this.socket||window.socket||Backbone.socket}var events=ioEvents[eventName];if(!_.isEmpty(events)){if(callback&&"function"===typeof callback){for(var i=0,l=events.length;i<l;i++){if(callback==events[i].cbLocal){this.unbind(events[i].name,events[i].cbLocal);io.removeListener(events[i].global,events[i].cbGlobal);events[i]=false}}events=_.compact(events)}else{this.unbind(eventName);io.removeAllListeners(globalName)}if(events.length===0){delete ioEvents[eventName]}}return this};Backbone.Collection.prototype.ioUnbindAll=function(io){var ioEvents=this._ioEvents||(this._ioEvents={});if(!io)io=this.socket||window.socket||Backbone.socket;for(var ev in ioEvents){this.ioUnbind(ev,io)}return this}})();